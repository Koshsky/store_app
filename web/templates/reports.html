{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-chart-bar"></i> Отчеты</h1>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line"></i> Прибыль за месяц
                </h5>
            </div>
            <div class="card-body">
                <form id="profitForm">
                    <div class="mb-3">
                        <label for="month" class="form-label">Месяц</label>
                        <input type="month" class="form-control" id="month" name="month" value="{{ default_month }}"
                            required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-chart-line"></i> Получить отчет
                    </button>
                </form>
                <div id="profitResult" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <h6>Результат:</h6>
                        <p id="profitValue"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-trophy"></i> Топ-5 товаров
                </h5>
            </div>
            <div class="card-body">
                <form id="topProductsForm">
                    <div class="mb-3">
                        <label for="start_date" class="form-label">Начальная дата</label>
                        <input type="date" class="form-control" id="start_date" name="start_date"
                            value="{{ default_start }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="end_date" class="form-label">Конечная дата</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" value="{{ default_end }}"
                            required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-trophy"></i> Получить отчет
                    </button>
                </form>
                <div id="topProductsResult" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <h6>Топ-5 товаров:</h6>
                        <div id="topProductsList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history"></i> История отчетов
                </h5>
            </div>
            <div class="card-body">
                <div id="reportsHistory">
                    <!-- Здесь будут отображаться результаты отчетов -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('profitForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const month = formData.get('month');
        const year = month.split('-')[0];
        const monthOnly = month.split('-')[1];

        fetch('{{ url_for("get_profit") }}', {
            method: 'POST',
            body: new URLSearchParams({
                'month': monthOnly,
                'year': year
            }),
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('profitResult');
                const profitValue = document.getElementById('profitValue');

                if (data.success) {
                    profitValue.textContent = `Прибыль за ${month}: ${data.data.profit !== undefined ? data.data.profit + ' ₽' : 'Данные недоступны'}`;
                    resultDiv.style.display = 'block';

                    // Добавляем в историю
                    addToHistory(`Прибыль за ${month}: ${data.data.profit !== undefined ? data.data.profit + ' ₽' : 'Данные недоступны'}`);
                } else {
                    profitValue.textContent = `Ошибка: ${data.error}`;
                    resultDiv.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ошибка при получении данных');
            });
    });

    document.getElementById('topProductsForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);

        fetch('{{ url_for("get_top_products") }}', {
            method: 'POST',
            body: formData,
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('topProductsResult');
                const productsList = document.getElementById('topProductsList');

                if (data.success && data.data) {
                    let html = '<ol>';
                    data.data.forEach((product, index) => {
                        html += `<li>${product.name || 'Товар'} - ${product.revenue !== undefined ? product.revenue + ' ₽' : 'Доход недоступен'}</li>`;
                    });
                    html += '</ol>';
                    productsList.innerHTML = html;
                    resultDiv.style.display = 'block';

                    // Добавляем в историю
                    addToHistory(`Топ-5 товаров с ${formData.get('start_date')} по ${formData.get('end_date')}`);
                } else {
                    productsList.innerHTML = `<p>Ошибка: ${data.error || 'Данные недоступны'}</p>`;
                    resultDiv.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ошибка при получении данных');
            });
    });

    function addToHistory(reportText) {
        const historyDiv = document.getElementById('reportsHistory');
        const reportElement = document.createElement('div');
        reportElement.className = 'alert alert-secondary';
        reportElement.innerHTML = `
        <small>${new Date().toLocaleString()}</small><br>
        ${reportText}
    `;
        historyDiv.insertBefore(reportElement, historyDiv.firstChild);
    }
</script>
{% endblock %}